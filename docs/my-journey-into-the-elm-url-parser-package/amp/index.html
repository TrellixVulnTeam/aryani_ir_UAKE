<!DOCTYPE html>
<html ⚡>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    <title>Elm Url Parser</title>

    <meta name="description" content="how elm Url Parser package works" />
    <link rel="canonical" href="../index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="aryani.ir" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Elm Url Parser" />
    <meta property="og:description" content="how elm Url Parser package works" />
    <meta property="og:url" content="aryani.ir/my-journey-into-the-elm-url-parser-package/" />
    <meta property="og:image" content="aryani.ir/content/images/2021/01/benoit-beaumatin-xdai21Y9pek-unsplash.jpg" />
    <meta property="article:published_time" content="2021-01-14T00:10:26.000Z" />
    <meta property="article:modified_time" content="2021-01-14T00:10:26.000Z" />
    <meta property="article:tag" content="elm" />
    <meta property="article:tag" content="functional" />
    <meta property="article:tag" content="programming" />
    <meta property="article:tag" content="type" />
    <meta property="article:tag" content="url" />
    <meta property="article:tag" content="web" />
    
    <meta property="article:publisher" content="https://www.facebook.com/ghost" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Elm Url Parser" />
    <meta name="twitter:description" content="how elm Url Parser package works" />
    <meta name="twitter:url" content="aryani.ir/my-journey-into-the-elm-url-parser-package/" />
    <meta name="twitter:image" content="aryani.ir/content/images/2021/01/benoit-beaumatin-xdai21Y9pek-unsplash.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Sepehr Aryani" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="elm, functional, programming, type, url, web" />
    <meta name="twitter:site" content="@ghost" />
    <meta property="og:image:width" content="640" />
    <meta property="og:image:height" content="427" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "aryani.ir",
        "url": "aryani.ir/",
        "logo": {
            "@type": "ImageObject",
            "url": "aryani.ir/content/images/2020/12/aryani-4.svg"
        }
    },
    "author": {
        "@type": "Person",
        "name": "Sepehr Aryani",
        "image": {
            "@type": "ImageObject",
            "url": "//www.gravatar.com/avatar/0c8ce11d7f0ab0c1ab9b51a5e279c790?s=250&d=mm&r=x",
            "width": 250,
            "height": 250
        },
        "url": "aryani.ir/author/sepehr/",
        "sameAs": []
    },
    "headline": "Elm Url Parser",
    "url": "aryani.ir/my-journey-into-the-elm-url-parser-package/",
    "datePublished": "2021-01-14T00:10:26.000Z",
    "dateModified": "2021-01-14T00:10:26.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "aryani.ir/content/images/2021/01/benoit-beaumatin-xdai21Y9pek-unsplash.jpg",
        "width": 640,
        "height": 427
    },
    "keywords": "elm, functional, programming, type, url, web",
    "description": "\nRecently I was asked by one of my customers to create a website for her vet\nclinic, she wanted the website to act like an app (SPA/PWA) when opened on\nmobile phones. I was not under time pressure, and I always wanted to learn Elm\n[https://elm-lang.org/], so it seemed the perfect time to learn something and\nmake some money at the same time.\n\nIt turned out that learning elm is going to be very challenging. Elm is a purely\nfunctional programming language that can only be used to develop web apps (",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "aryani.ir/"
    }
}
    </script>

    <meta name="generator" content="Ghost 3.40" />
    <link rel="alternate" type="application/rss+xml" title="aryani.ir" href="../../rss/index.html" />

    <style amp-custom>
    *,
    *::before,
    *::after {
        box-sizing: border-box;
    }

    html {
        overflow-x: hidden;
        overflow-y: scroll;
        font-size: 62.5%;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }

    body {
        min-height: 100vh;
        margin: 0;
        padding: 0;
        color: #3a4145;
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        font-size: 1.7rem;
        line-height: 1.55em;
        font-weight: 400;
        font-style: normal;
        background: #fff;
        scroll-behavior: smooth;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    p,
    ul,
    ol,
    li,
    dl,
    dd,
    hr,
    pre,
    form,
    table,
    video,
    figure,
    figcaption,
    blockquote {
        margin: 0;
        padding: 0;
    }

    ul[class],
    ol[class] {
        padding: 0;
        list-style: none;
    }

    img {
        display: block;
        max-width: 100%;
    }

    input,
    button,
    select,
    textarea {
        font: inherit;
        -webkit-appearance: none;
    }

    fieldset {
        margin: 0;
        padding: 0;
        border: 0;
    }

    label {
        display: block;
        font-size: 0.9em;
        font-weight: 700;
    }

    hr {
        position: relative;
        display: block;
        width: 100%;
        height: 1px;
        border: 0;
        border-top: 1px solid currentcolor;
        opacity: 0.1;
    }

    ::selection {
        text-shadow: none;
        background: #cbeafb;
    }

    mark {
        background-color: #fdffb6;
    }

    small {
        font-size: 80%;
    }

    sub,
    sup {
        position: relative;
        font-size: 75%;
        line-height: 0;
        vertical-align: baseline;
    }
    sup {
        top: -0.5em;
    }
    sub {
        bottom: -0.25em;
    }

    ul li + li {
        margin-top: 0.6em;
    }

    a {
        color: #1292EE;
        text-decoration-skip-ink: auto;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        margin: 0;
        font-weight: 700;
        color: #121212;
        line-height: 1.4em;
    }

    h1 {
        font-size: 3.4rem;
        line-height: 1.1em;
    }

    h2 {
        font-size: 2.4rem;
        line-height: 1.2em;
    }

    h3 {
        font-size: 1.8rem;
    }

    h4 {
        font-size: 1.7rem;
    }

    h5 {
        font-size: 1.6rem;
    }

    h6 {
        font-size: 1.6rem;
    }

    amp-img {
        height: 100%;
        width: 100%;
        max-width: 100%;
        max-height: 100%;
    }

    amp-img img {
        object-fit: cover;
    }

    .page-header {
        padding: 50px 5vmin 30px;
        text-align: center;
        font-size: 2rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .page-header a {
        color: #121212;
        font-weight: 700;
        text-decoration: none;
        font-size: 1.6rem;
        letter-spacing: -0.1px;
    }

    .post {
        max-width: 680px;
        margin: 0 auto;
    }

    .post-header {
        margin: 0 5vmin 5vmin;
        text-align: center;
    }

    .post-meta {
        margin: 1rem 0 0 0;
        text-transform: uppercase;
        color: #738a94;
        font-weight: 500;
        font-size: 1.3rem;
    }

    .post-image {
        margin: 0 0 5vmin;
    }

    .post-image img {
        display: block;
        width: 100%;
        height: auto;
    }

    .post-content {
        padding: 0 5vmin;
    }

    .post-content > * + * {
        margin-top: 1.5em;
    }

    .post-content [id]:not(:first-child) {
        margin: 2em 0 0;
    }

    .post-content > [id] + * {
        margin-top: 1rem;
    }

    .post-content [id] + .kg-card,
    .post-content blockquote + .kg-card {
        margin-top: 40px;
    }

    .post-content > ul,
    .post-content > ol,
    .post-content > dl {
        padding-left: 1.9em;
    }

    .post-content hr {
        margin-top: 40px;
    }

    .post .post-content hr + * {
        margin-top: 40px;
    }

    .post-content amp-img {
        background-color: #f8f8f8;
    }

    .post-content blockquote {
        position: relative;
        font-style: italic;
    }

    .post-content blockquote::before {
        content: "";
        position: absolute;
        left: -1.5em;
        top: 0;
        bottom: 0;
        width: 0.3rem;
        background: #000;
    }

    .post-content :not(.kg-card):not([id]) + .kg-card {
        margin-top: 40px;
    }

    .post-content .kg-card + :not(.kg-card) {
        margin-top: 40px;
    }

    .kg-card figcaption {
        padding: 1.5rem 1.5rem 0;
        text-align: center;
        font-weight: 500;
        font-size: 1.3rem;
        line-height: 1.4em;
        opacity: 0.6;
    }

    .kg-card figcaption strong {
        color: rgba(0,0,0,0.8);
    }

    .post-content :not(pre) code {
        vertical-align: middle;
        padding: 0.15em 0.4em 0.15em;
        border: #e1eaef 1px solid;
        font-weight: 400;
        font-size: 0.9em;
        line-height: 1em;
        color: #dc0050;
        background: #f0f6f9;
        border-radius: 0.25em;
    }

    .post-content > pre {
        overflow: scroll;
        padding: 16px 20px;
        color: #fff;
        background: #1F2428;
        border-radius: 5px;
        box-shadow: 0 2px 6px -2px rgba(0,0,0,.1), 0 0 1px rgba(0,0,0,.4);
    }

    .kg-embed-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }

    .kg-image-card img {
        margin: auto;
    }

    .kg-gallery-card + .kg-gallery-card {
        margin-top: 0.75em;
    }

    .kg-gallery-container {
        position: relative;
    }

    .kg-gallery-row {
        display: flex;
        flex-direction: row;
        justify-content: center;
    }

    .kg-gallery-image {
        width: 100%;
        height: 100%;
    }

    .kg-gallery-row:not(:first-of-type) {
        margin: 0.75em 0 0 0;
    }

    .kg-gallery-image:not(:first-of-type) {
        margin: 0 0 0 0.75em;
    }

    .kg-bookmark-card,
    .kg-bookmark-publisher {
        position: relative;
    }

    .kg-bookmark-container,
    .kg-bookmark-container:hover {
        display: flex;
        flex-wrap: wrap;
        flex-direction: row-reverse;
        color: currentColor;
        background: rgba(255,255,255,0.6);
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        text-decoration: none;
        border-radius: 5px;
        box-shadow: 0 2px 6px -2px rgba(0, 0, 0, 0.1), 0 0 1px rgba(0, 0, 0, 0.4);
        overflow: hidden;
    }

    .kg-bookmark-content {
        flex-basis: 0;
        flex-grow: 999;
        padding: 20px;
        order: 1;
    }

    .kg-bookmark-title {
        font-weight: 600;
        font-size: 1.5rem;
        line-height: 1.3em;
    }

    .kg-bookmark-description {
        display: -webkit-box;
        max-height: 45px;
        margin: 0.5em 0 0 0;
        font-size: 1.4rem;
        line-height: 1.55em;
        overflow: hidden;
        opacity: 0.8;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .kg-bookmark-metadata {
        margin-top: 20px;
    }

    .kg-bookmark-metadata {
        display: flex;
        align-items: center;
        font-weight: 500;
        font-size: 1.3rem;
        line-height: 1.3em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .kg-bookmark-description {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
    }

    .kg-bookmark-metadata amp-img {
        width: 18px;
        height: 18px;
        max-width: 18px;
        max-height: 18px;
        margin-right: 10px;
    }

    .kg-bookmark-thumbnail {
        display: flex;
        flex-basis: 20rem;
        flex-grow: 1;
        justify-content: flex-end;
    }

    .kg-bookmark-thumbnail amp-img {
        max-height: 200px;
    }

    .kg-bookmark-author {
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    .kg-bookmark-publisher::before {
        content: "•";
        margin: 0 .5em;
    }

    .kg-width-full.kg-card-hascaption {
        display: grid;
        grid-template-columns: inherit;
    }

    .post-content table {
        border-collapse: collapse;
        width: 100%;
    }

    .post-content th {
        padding: 0.5em 0.8em;
        text-align: left;
        font-size: .75em;
        text-transform: uppercase;
    }

    .post-content td {
        padding: 0.4em 0.7em;
    }

    .post-content tbody tr:nth-child(2n + 1) {
        background-color: rgba(0,0,0,0.1);
        padding: 1px;
    }

    .post-content tbody tr:nth-child(2n + 2) td:last-child {
        box-shadow:
            inset 1px 0 rgba(0,0,0,0.1),
            inset -1px 0 rgba(0,0,0,0.1);
    }

    .post-content tbody tr:nth-child(2n + 2) td {
        box-shadow: inset 1px 0 rgba(0,0,0,0.1);
    }

    .post-content tbody tr:last-child {
        border-bottom: 1px solid rgba(0,0,0,.1);
    }

    .page-footer {
        padding: 60px 5vmin;
        margin: 60px auto 0;
        text-align: center;
        background-color: #f8f8f8;
    }

    .page-footer h3 {
        margin: 0.5rem 0 0 0;
    }

    .page-footer p {
        max-width: 500px;
        margin: 1rem auto 1.5rem;
        font-size: 1.7rem;
        line-height: 1.5em;
        color: rgba(0,0,0,0.6)
    }

    .powered {
        display: inline-flex;
        align-items: center;
        margin: 30px 0 0;
        padding: 6px 9px 6px 6px;
        border: rgba(0,0,0,0.1) 1px solid;
        font-size: 12px;
        line-height: 12px;
        letter-spacing: -0.2px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
        font-weight: 500;
        color: #222;
        text-decoration: none;
        background: #fff;
        border-radius: 6px;
    }

    .powered svg {
        height: 16px;
        width: 16px;
        margin: 0 6px 0 0;
    }

    @media (max-width: 600px) {
        body {
            font-size: 1.6rem;
        }
        h1 {
            font-size: 3rem;
        }

        h2 {
            font-size: 2.2rem;
        }
    }

    @media (max-width: 400px) {
        h1 {
            font-size: 2.6rem;
            line-height: 1.15em;
        }
        h2 {
            font-size: 2rem;
            line-height: 1.2em;
        }
        h3 {
            font-size: 1.7rem;
        }
    }
    </style>

    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>

    

</head>

<body class="amp-template">
    <header class="page-header">
        <a href="../../index.html">
                aryani.ir
        </a>
    </header>

    <main class="content" role="main">
        <article class="post">

            <header class="post-header">
                <h1 class="post-title">my journey into the elm url parser package</h1>
                <section class="post-meta">
                    Sepehr Aryani -
                    <time class="post-date" datetime="2021-01-14">14 Jan 2021</time>
                </section>
            </header>
            <figure class="post-image">
                <amp-img src="aryani.ir/content/images/2021/01/benoit-beaumatin-xdai21Y9pek-unsplash.jpg" width="600" height="340" layout="responsive"></amp-img>
            </figure>
            <section class="post-content">

                <h1></h1><p>Recently I was asked by one of my customers to create a website for her vet clinic, she wanted the website to act like an app (SPA/PWA) when opened on mobile phones. I was not under time pressure, and I always wanted to learn <a href="https://elm-lang.org/">Elm</a>, so it seemed the perfect time to learn something and make some money at the same time.</p><p>It turned out that learning elm is going to be very challenging. Elm is a purely functional programming language that can only be used to develop web apps (as of now). I had some experience with some other functional languages like <a href="https://clojure.org/">clojure</a> so I thought It would not be that different, but I was wrong. The language is so radically different than all other languages (e.g. javascript) that to me it felt like learning programming from scratch.</p><p>Also, learning materials like online tutorials, videos and books are so scarce, so if you are planning to learn elm be prepared that you are going to read a lot of other's codes.</p><p>Elm belongs to the ML family of languages and it has its roots in <a href="https://haskell.org/">haskell</a>, in fact, the elm compiler itself is written in haskell. As far as I can tell compared to haskell, elm is a fairly smaller language, but small things are not necessarily easy as well. The most mind-bending (and beautiful) feature of elm is its typing system. using its sophisticated type inference elm can detect (almost) all bugs on compile time so you are free from runtime exceptions :)</p><p>While I was learning about elm by reading source codes I stumbled upon <a href="https://package.elm-lang.org/packages/elm/url/latest/Url-Parser">Url.Parser</a> package. I could not understand why they package is designed the it is and samples were not helpful. So I set out to dig into the package source code and see what I get out of it.</p><p>I have an attitude of breaking complex stuff recursively until I grok every single concept, then I build my way up until I construct the big picture.</p><p>I took this simple piece of coded and decided to apply my method on it.</p><pre><code class="language-elm">import Url exposing (..)
import Url.Parser exposing (..)

urlMaybe = fromString "https://example.com/foo/bar/1987"

case urlMaybe of
  Just url -&gt; 
    case (parse (s "foo" &lt;/&gt; s "bar" &lt;/&gt; int) url) of
      Just year -&gt; year
      Nothing -&gt; -1
  Nothing -&gt; -1
</code></pre><p>Looking at the code above I can say it is fairly straightforward and meaningful except for this line:</p><pre><code class="language-elm">parse (s "foo" &lt;/&gt; s "bar" &lt;/&gt; int) url
</code></pre><p>Hmmmmmm, it looks so cryptic!!! What is this <code>s "blah blah"</code> thing or this weird <code>&lt;/&gt;</code> symbol, how does <code>parse</code> function parses the url. Running the code above in elm REPL results in this value:</p><pre><code class="language-elm">1987 : Int
</code></pre><p>Why? Whyyyy? I mean Why? What about the rest of the url, does <code>parse</code> function always return the last part of the url (in our case "1987") or what??? Ok, I need to break it down to its pieces:</p><pre><code class="language-elm">parse (s "foo" &lt;/&gt; s "bar" &lt;/&gt; int) url =&gt; Maybe 1987
┗━┳━┛ ┗━━━━━━━━━━━━━┳━━━━━━━━━━━━━┛ ┗┳┛
parse:      Parser (a -&gt; a) a    -&gt; Url -&gt; Maybe a
┏━┻━┓ ┏━━━━━━━━━━━━━┻━━━━━━━━━━━━━┓ ┏┻┓    ┏━━┻━━┓
 AHA               WTF              WTF      AHA
</code></pre><p>Ok, so <code>parse</code> takes in a <code>Parser</code> and an <code>Url</code> then returns a <code>Maybe</code> value. I understand the return type so I tagged it as <strong>AHA</strong> . Before jumping into the parse function lets see how the <code>Url</code> tpye represents our url value:</p><pre><code class="language-elm">type Protocol = Http | Https

type alias Url =
  { protocol : Protocol      -- Https
  , host : String            -- example.com
  , port_ : Maybe Int        -- Nothing
  , path : String            -- /foo/bar/1987
  , query : Maybe String     -- Nothing
  , fragment : Maybe String  -- Nothing
  }
</code></pre><p>Aha, so this is how our url value is kept as a <code>Url</code> type, easy peasy. Ok, we have progressed one more step, so let me update our <strong>AHA</strong> tags:</p><pre><code class="language-elm">parse (s "foo" &lt;/&gt; s "bar" &lt;/&gt; int) url =&gt; Maybe 1987
┗━┳━┛ ┗━━━━━━━━━━━━━┳━━━━━━━━━━━━━┛ ┗┳┛
parse:      Parser (a -&gt; a) a    -&gt; Url -&gt; Maybe a
┏━┻━┓ ┏━━━━━━━━━━━━━┻━━━━━━━━━━━━━┓ ┏┻┓    ┏━━┻━━┓
 AHA               WTF              AHA      AHA
</code></pre><p>Cool, I have only one <strong>WTF</strong> to solve. To simplify things I will remove all other <strong>AHA</strong>s and focus on the last <strong>WTF</strong> item, sooo, what do I do next, yes I break it down again:</p><pre><code class="language-elm">s "foo" &lt;/&gt; s "bar" &lt;/&gt; int
┗━━┳━━┛ ┗┳┛ ┗━━┳━━┛ ┗┳┛ ┗┳┛
┏━━┻━━┓ ┏┻┓ ┏━━┻━━┓ ┏┻┓ ┏┻┓
  WTF   WTF   WTF   WTF WTF
</code></pre><p>Oh shhhhhh, five new <strong>WTF</strong>s, Dang it. OK so I can see that in fact there are only three distict <strong>WTF</strong> in the expression above:</p><pre><code class="language-elm">s "foo" &lt;/&gt; s "bar" &lt;/&gt; int
┗━━┳━━┛ ┗┳┛ ┗━━┳━━┛ ┗┳┛ ┗┳┛
┏━━┻━━┓ ┏┻┓ ┏━━┻━━┓ ┏┻┓ ┏┻┓
  WTF   WTF   WTF   WTF WTF
┗━━┳━━┛ ┗┳┛ ┗━━┳━━┛ ┗┳┛ ┗┳┛
   ┃     ┗━━━━━┿━━┳━━┛   ┃
   ┗━━━━━┳━━━━━┛  ┃      ┃
      s "foo"    &lt;/&gt;    int
      s "bar"    &lt;/&gt;    ┃ ┃
      ┗━━┳━━┛    ┗┳┛    ┗┳┛
        WTF      WTF    WTF
</code></pre><p>Ok, out of the above animals, <code>int</code> seems less scary, so let us look at its definition, I had to modify the <code>int</code> definition a bit just to make it look nicer, so here it is:</p><pre><code class="language-elm">int : Parser (Int -&gt; a) a
int = 
  Parser &lt;| \{ visited, unvisited, params, frag, value } -&gt;
    case unvisited of
      [] -&gt; []
      next :: rest -&gt;
        case (String.toInt next) of
          Just nextValue -&gt; [ State (next :: visited) rest params frag (value nextValue) ]
          Nothing -&gt; []
</code></pre><p>It says that calling <code>int</code> would get us a value of <code>Parser</code> type, uhh! what the hell is <code>Parser</code> type? I go back and find its definition, here it is:</p><pre><code class="language-elm">type Parser a b = Parser (State a -&gt; List (State b))

type alias State value =
  { visited : List String
  , unvisited : List String
--, params : Dict String (List String)
--, frag : Maybe String
  , value : value
  }
</code></pre><p>For the sake of simplicity I have commented out <code>params</code> and <code>frag</code> fields from <code>State</code> type, I will exclude them altogether later on as if they never existed!</p><p>Ok, This <code>type Parser a b = Parser (State a -&gt; List (State b))</code> reads like this:</p><p><code>Parser</code> is a <a href="https://en.wikipedia.org/wiki/Tagged_union">union type</a> that accepts two type variables <code>a</code> and <code>b</code> <strong>AND</strong> has one type variant with the same name as <code>Parser</code>. Don't worry, it is a normal thing in elm and also in haskell (I guess).</p><pre><code class="language-elm">      type Parser a b = Parser (State a -&gt; List (State b))
           ┗━━┳━┛ ┗┳┛   ┗━━┳━┛ ┗━━━━━━━━━━━━┳━━━━━━━━━━━━┛
              ┃    ┃       ┃                ┃
-- type name ━┛    ┃       ┃                ┃
-- type variables ━┛       ┃                ┃
-- type varianat (tag) ━━━━┛                ┃
-- function that takes a state and returns┏━┛
--                        a list of states┃
</code></pre><p><code>Parser</code> the variant is actually a function that accepts a value of <code>State a</code> type and converts it into a <code>List (State b)</code>. piece of cake. It's time to continue where we left off, the <code>int</code> parser function, this time with even more simplification:</p><pre><code class="language-elm">int : Parser (Int -&gt; a) a
int = 
  Parser &lt;| \{ visited, unvisited, value } -&gt;
    case unvisited of  
      next :: rest -&gt;
        case (String.toInt next) of
          Just nextValue -&gt; [ State (next :: visited) rest (value nextValue) ]

-- notice that I have also dropped params and frag from parser funtion input
-- and its return value
</code></pre><p>Looking at the half-ass code above we can read:</p><p><code>int</code> is a parser function that accepts a <code>State</code> value, then takes the first item from unvisited list, converts it to <code>Int</code>, constructs a new <code>State</code> value, moves the item from unvisited list to visited list, applies the item  mysterious <code>value</code> function and returns the newly created <code>State</code> value wrapped in a <code>List</code>. It's time to update our <strong>WTF</strong>s:</p><pre><code class="language-elm">s "foo" &lt;/&gt; s "bar" &lt;/&gt; int
┗━━┳━━┛ ┗┳┛ ┗━━┳━━┛ ┗┳┛ ┗┳┛
┏━━┻━━┓ ┏┻┓ ┏━━┻━━┓ ┏┻┓ ┏┻┓
  WTF   WTF   WTF   WTF AHA
┗━━┳━━┛ ┗┳┛ ┗━━┳━━┛ ┗┳┛ ┗┳┛
   ┃     ┗━━━━━┿━━┳━━┛   ┃
   ┗━━━━━┳━━━━━┛  ┃      ┃
      s "foo"    &lt;/&gt;    int
      s "bar"    &lt;/&gt;    ┃ ┃
      ┗━━┳━━┛    ┗┳┛    ┗┳┛
        WTF      WTF    AHA
</code></pre><p>We are now left with these two animals: <code>s</code> and <code>&lt;/&gt;</code>, let's see what <code>s</code> is (again simplified):</p><pre><code class="language-elm">s : String -&gt; Parser a a
s str =
  Parser &lt;| \{ visited, unvisited, value } -&gt;
    case unvisited of      
      next :: rest -&gt; [ State (next :: visited) rest value ]        
</code></pre><p>Uh, ok, so <code>s</code> is a function that accepts a <code>String</code> and spits out a <code>Parser</code> function, hmmmm. Looking at the body of <code>s</code> function reveals that it does exactly what <code>int</code> does, except that it does not do anything with the consumed item from unvisited list, hence the mysterious <code>value</code> thing is untouched. In other words this function is only here to consume something and not do anything, <strong>BINGO</strong>, now things are making more sense, remember this?</p><pre><code class="language-elm">Maybe 1987
</code></pre><p>Ok Ok Ok, <code>s</code> was a lot easier than I thought, now let's get back to our business:</p><pre><code class="language-elm">s "foo" &lt;/&gt; s "bar" &lt;/&gt; int
┗━━┳━━┛ ┗┳┛ ┗━━┳━━┛ ┗┳┛ ┗┳┛
┏━━┻━━┓ ┏┻┓ ┏━━┻━━┓ ┏┻┓ ┏┻┓
  AHA   WTF   AHA   WTF AHA
┗━━┳━━┛ ┗┳┛ ┗━━┳━━┛ ┗┳┛ ┗┳┛
   ┃     ┗━━━━━┿━━┳━━┛   ┃
   ┗━━━━━┳━━━━━┛  ┃      ┃
      s "foo"    &lt;/&gt;    int
      s "bar"    &lt;/&gt;    ┃ ┃
      ┗━━┳━━┛    ┗┳┛    ┗┳┛
        AHA      WTF    AHA
</code></pre><p>This is what we get from source code about <code>&lt;/&gt;</code>:</p><pre><code class="language-elm">infix right 7 (&lt;/&gt;) = slash

slash : Parser a b -&gt; Parser b c -&gt; Parser a c
slash (Parser parseBefore) (Parser parseAfter) =
  Parser &lt;| \state -&gt;
    List.concatMap parseAfter (parseBefore state)
</code></pre><p>Actually there are some details hidden in the first line and there is something special about it. This line starts by calling <code>infix</code> function to define an infix operator which is assigned to <code>&lt;/&gt;</code> symbol, this symbol is then bound to <code>slash</code> function.</p><p>The stupid thing is that after hours and hours of googling I could not find any documentations about <code>infix</code> function. So I set out to play with the function in elm REPL to see how it works, well ... I could not. It turns out that it is impossible to define a custom <code>infix</code> operator. Whaaaaat!!!. How come I cannot but <strong>Url.Parser</strong> can? Don't believe me? try it for yourself.</p><p>Anyways, after hours of head scratching <a href="https://discourse.elm-lang.org/t/how-to-create-custom-infix-operators/6690">I decided to ask the folks at elm discourse community about this phenomenon</a>. The answers my shock you</p><p>Just like before, forget about nonsense parts and focus on the problem, so let's say this is the implementation of <code>&lt;/&gt;</code> function:</p><pre><code class="language-elm">(&lt;/&gt;) : Parser a b -&gt; Parser b c -&gt; Parser a c
(&lt;/&gt;) (Parser parseBefore) (Parser parseAfter) =
  Parser &lt;| \state -&gt;
    List.concatMap parseAfter (parseBefore state)
</code></pre><p>This is obviously saying that <code>&lt;/&gt;</code> is a function that takes in two <code>Parser</code>s and then combines them together into a single <code>Parser</code>, right? Kinda!</p><p><code>List.concatMap</code> works like <code>List.map</code>, the only difference is that the final list gets flattened. This means that <code>&lt;/&gt;</code> returns a ordinary <code>Parser</code> function that as always takes in a <code>State</code> value and returns a list of <code>State</code> values. <code>&lt;/&gt;</code> function applies states values to parser function from left to right.</p><p>OK, at this point we can say that everything is revealed, except for one thing! remember that <strong>shady</strong> <code>value</code> thing? In order to see what <code>value</code> is we need to take a look at the <code>parse</code> function it self (simplified version):</p><pre><code class="language-elm">parse : Parser (a -&gt; a) a -&gt; Url -&gt; Maybe a
parse (Parser parser) url =
  getFirstMatch &lt;| parser &lt;|
    State [] (preparePath url.path) identity

getFirstMatch : List (State a) -&gt; Maybe a
getFirstMatch states =
  case states of
    [] -&gt; Nothing
    state :: rest -&gt;
      case state.unvisited of
        [] -&gt; Just state.value  
        _ -&gt; getFirstMatch rest
</code></pre><p>So when we first called this:</p><pre><code class="language-elm">parse (s "foo" &lt;/&gt; s "bar" &lt;/&gt; int) url
</code></pre><p>The <code>parse</code> function created a brand new <code>State</code> value for us:</p><pre><code class="language-elm">                   State [] (preparePath url.path) identity
                   ┗━┳━┛ ┗┳┛┗━━━━━━━━━┳━━━━━━━━━━┛ ┗━━━┳━━┛
-- State type alias ━┛    ┃           ┃                ┃
-- empty visited list ━━━━┛           ┃                ┃
                            ┏━━━━━━━━━┻━━━━━━━━━━┓     ┃                      
                            ["foo", "bar", "1987"]     ┃
                            ┗━━━━━━━━━┳━━━━━━━━━━┛     ┃
-- list of unvisited url path items ━━┛                ┃
-- identity function ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛ 
</code></pre><p>Finally we have covered the whole thing, so to summarize the <code>parse</code> function we can break it into these steps:</p><ul><li><code>parse</code> function takes the <code>Url</code> path value which is a string and converts it to a list of <code>Strings</code> : "foo/bar/1987" =&gt; ['foo', 'bar', 1987]</li><li>a fresh <code>State</code> value is created that</li><li>has empty visited items</li><li>its unvisied list is filled with ['foo', 'bar', 1987]</li><li>the state value is sent through our <code>Parser</code> functions pipeline</li><li>the first <code>Parser</code> function (<code>s "foo"</code>) consumes <strong>"foo"</strong> and does nothing</li><li>the second <code>Parser</code> function (<code>s "bar"</code>) consumes <strong>"bar"</strong> and does nothing</li><li>the third and last <code>Parser</code> function (<code>int</code>) consumes <strong>"1987"</strong> string and truns it into a value of type <code>Int</code>, then passes this integer value to <code>identity</code> function which was initially stored into <code>value</code> : <code>value = identity</code></li><li>The result is <code>Maybe 1987</code></li></ul><p>Thank you</p><pre><code class="language-elm">s "foo" &lt;/&gt; s "bar" &lt;/&gt; int
┗━━┳━━┛ ┗┳┛ ┗━━┳━━┛ ┗┳┛ ┗┳┛
┏━━┻━━┓ ┏┻┓ ┏━━┻━━┓ ┏┻┓ ┏┻┓
  AHA   AHA   AHA   AHA AHA
┗━━┳━━┛ ┗┳┛ ┗━━┳━━┛ ┗┳┛ ┗┳┛
   ┃     ┗━━━━━┿━━┳━━┛   ┃
   ┗━━━━━┳━━━━━┛  ┃      ┃
      s "foo"    &lt;/&gt;    int ━━━━ 1987
      s "bar"    &lt;/&gt;    ┃ ┃
      ┗━━┳━━┛    ┗┳┛    ┗┳┛
        AHA      AHA    AHA
</code></pre>

            </section>

        </article>
    </main>
    <footer class="page-footer">
        <h3>aryani.ir</h3>
            <p>thoughts on software</p>
        <p><a href="../../index.html">Read more posts →</a></p>
        <a class="powered" href="https://ghost.org" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 156 156"><g fill="none" fill-rule="evenodd"><rect fill="#15212B" width="156" height="156" rx="27"/><g transform="translate(36 36)" fill="#F6F8FA"><path d="M0 71.007A4.004 4.004 0 014 67h26a4 4 0 014 4.007v8.986A4.004 4.004 0 0130 84H4a4 4 0 01-4-4.007v-8.986zM50 71.007A4.004 4.004 0 0154 67h26a4 4 0 014 4.007v8.986A4.004 4.004 0 0180 84H54a4 4 0 01-4-4.007v-8.986z"/><rect y="34" width="84" height="17" rx="4"/><path d="M0 4.007A4.007 4.007 0 014.007 0h41.986A4.003 4.003 0 0150 4.007v8.986A4.007 4.007 0 0145.993 17H4.007A4.003 4.003 0 010 12.993V4.007z"/><rect x="67" width="17" height="17" rx="4"/></g></g></svg> Published with Ghost</a>
    </footer>
    
</body>
</html>
